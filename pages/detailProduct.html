<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Detail - MyStore</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"
    />
    <style>
      :root {
        --primary-color: #024783;
      }
      .navbar {
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* Product Images Slider */
      .product-images {
        position: relative;
        background: white;
      }

      .product-swiper {
        height: 360px;
      }

      .product-slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .modal-dialog-bottom {
        margin: 0;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
      }

      .product-preview {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
      }

      .quantity-control {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .variant-options {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .image-counter {
        position: absolute;
        right: 10px;
        bottom: 10px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        z-index: 1;
      }

      /* Product Info Section */
      .product-info {
        background: white;
        padding: 1rem;
        margin-top: 8px;
      }

      .product-price {
        color: var(--primary-color);
        font-size: 1.5rem;
        font-weight: bold;
      }

      .coin-plus {
        font-size: 0.8rem;
        color: #ffa726;
      }

      .product-rating {
        color: var(--primary-color);
        font-size: 0.9rem;
      }

      /* Variant Selection */
      .variant-section {
        background: white;
        padding: 1rem;
        margin-top: 8px;
      }

      .thumbnail-strip {
        padding: 1rem;
        background: white;
        border-top: 1px solid #eee;
      }

      .variant-thumbs {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 8px;
        scrollbar-width: none;
      }

      .variant-thumb {
        width: 60px;
        height: 60px;
        border-radius: 4px;
        border: 1px solid #ddd;
        cursor: pointer;
        flex-shrink: 0;
      }

      .variant-thumb.active {
        border: 2px solid var(--primary-color);
      }

      .variant-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 3px;
      }

      .variant-title {
        color: #757575;
        margin-bottom: 0.5rem;
      }

      .variant-option {
        border: 1px solid #ddd;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-size: 0.9rem;
      }

      .variant-option.selected {
        border-color: var(--primary-color);
        color: var(--primary-color);
      }

      /* Description */
      .description-section {
        background: white;
        padding: 1rem;
        margin-top: 8px;
      }

      .description-content {
        font-size: 0.9rem;
        color: #424242;
      }

      /* Bottom Action Bar */
      .action-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 0.75rem 1rem;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 0.75rem;
        z-index: 1000;
      }

      .action-button {
        flex: 1;
        padding: 0.75rem;
        border: none;
        border-radius: 4px;
        font-weight: 600;
      }

      .add-cart-btn {
        background: rgb(232, 242, 255);
        color: var(--primary-color);
      }

      .buy-now-btn {
        background: var(--primary-color);
        color: white;
      }

      /* Quantity Selector */
      .quantity-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .quantity-btn {
        width: 28px;
        height: 28px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .quantity-input {
        width: 40px;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 0.25rem;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar fixed-top">
      <div class="container-fluid">
        <div class="d-flex align-items-center gap-3">
          <a
            href="#"
            class="text-dark"
            onclick="window.history.back(); return false;"
          >
            <i class="bi bi-arrow-left fs-5"></i>
          </a>
          <h6 class="mb-0">Product Detail</h6>
        </div>
        <div class="d-flex gap-3">
          <a href="cart.html" class="text-dark">
            <i class="bi bi-bag fs-5"></i>
          </a>
          <a href="#" class="text-dark">
            <i class="bi bi-three-dots-vertical fs-5"></i>
          </a>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content" style="margin-top: 56px; margin-bottom: 65px">
      <!-- Product Images -->
      <div class="product-images">
        <div class="image-counter">1/5</div>
        <div class="swiper product-swiper">
          <div class="swiper-wrapper">
            <!-- Images will be loaded dynamically -->
          </div>
          <div class="swiper-pagination"></div>
        </div>
        <div class="thumbnail-strip">
          <div class="variant-thumbs">
            <!-- Variant thumbnails will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Product Info -->
      <div class="product-info">
        <h5 class="product-name mb-2"></h5>
        <div class="d-flex align-items-center gap-2 mb-2">
          <span class="product-price"></span>
          <span class="coin-plus"></span>
        </div>
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <div class="product-rating">
              <i class="bi bi-star-fill"></i>
              <span class="rating-value"></span>
            </div>
            <span class="text-muted">|</span>
            <span class="text-muted sales-count"></span>
          </div>
          <a href="#" class="text-dark">
            <i class="bi bi-share fs-5"></i>
          </a>
        </div>
      </div>

      <!-- Description -->
      <div class="description-section">
        <h6>Product Description</h6>
        <div class="description-content">
          <!-- Description will be loaded dynamically -->
        </div>
      </div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <button class="action-button add-cart-btn">Add to Cart</button>
      <button class="action-button buy-now-btn">Buy Now</button>
    </div>

    <div class="modal fade" id="addToCartModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-bottom">
        <div class="modal-content">
          <div class="modal-body">
            <div class="d-flex gap-3 mb-3">
              <img
                src=""
                id="modalProductImage"
                class="product-preview"
                alt=""
              />
              <div>
                <h6 id="modalProductName"></h6>
                <div class="product-price" id="modalProductPrice"></div>
                <div class="text-muted small">
                  Stock: <span id="modalProductStock">-</span>
                </div>
              </div>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>

            <!-- Variant Selection -->
            <div class="mb-3">
              <label class="form-label">Select Variant</label>
              <div class="variant-options" id="modalVariantOptions">
                <!-- Variants loaded dynamically -->
              </div>
            </div>

            <!-- Quantity Selection -->
            <div class="d-flex align-items-center justify-content-between mb-3">
              <label>Quantity</label>
              <div class="quantity-control">
                <button class="quantity-btn" id="modalDecreaseQty">-</button>
                <input
                  type="number"
                  id="modalQuantity"
                  class="quantity-input"
                  value="1"
                  min="1"
                />
                <button class="quantity-btn" id="modalIncreaseQty">+</button>
              </div>
            </div>

            <button class="action-button buy-now-btn w-100" id="modalAddToCart">
              Add to Cart
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="buyNowModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-bottom">
        <div class="modal-content">
          <div class="modal-body">
            <div class="d-flex gap-3 mb-3">
              <img
                src=""
                id="buyNowProductImage"
                class="product-preview"
                alt=""
              />
              <div>
                <h6 id="buyNowProductName"></h6>
                <div class="product-price" id="buyNowProductPrice"></div>
                <div class="text-muted small">
                  Stock: <span id="buyNowProductStock">-</span>
                </div>
              </div>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>

            <!-- Variant Selection -->
            <div class="mb-3">
              <label class="form-label">Select Variant</label>
              <div class="variant-options" id="buyNowVariantOptions">
                <!-- Variants loaded dynamically -->
              </div>
            </div>

            <!-- Quantity Selection -->
            <div class="d-flex align-items-center justify-content-between mb-3">
              <label>Quantity</label>
              <div class="quantity-control">
                <button class="quantity-btn" id="buyNowDecreaseQty">-</button>
                <input
                  type="number"
                  id="buyNowQuantity"
                  class="quantity-input"
                  value="1"
                  min="1"
                />
                <button class="quantity-btn" id="buyNowIncreaseQty">+</button>
              </div>
            </div>

            <button class="action-button buy-now-btn w-100" id="buyNowConfirm">
              Beli Sekarang
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
    <script type="module">
      import { supabase } from "../assets/js/supabase.js";
      import { cartManager } from "../assets/js/supabase.js";

      document.addEventListener("DOMContentLoaded", () => {
        loadProductDetails();
        cartManager.updateCartBadge();
      });

      // Get product ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get("id");

      // Initialize Swiper
      const productSwiper = new Swiper(".product-swiper", {
        pagination: {
          el: ".swiper-pagination",
          type: "fraction",
        },
      });

      // Load product details
      async function loadProductDetails() {
        try {
          const { data: product, error } = await supabase
            .from("products")
            .select(`*, product_variants(*)`)
            .eq("id", productId)
            .single();

          if (error) throw error;

          window.productData = product;

          // Setup swiper with main thumbnail
          const swiperWrapper = document.querySelector(
            ".product-swiper .swiper-wrapper"
          );
          swiperWrapper.innerHTML = `
      <div class="swiper-slide product-slide">
        <img src="${product.thumbnail}" alt="${product.name}" data-type="main">
      </div>
    `;

          // Setup variant thumbnails strip
          const variantThumbs = document.querySelector(".variant-thumbs");
          variantThumbs.innerHTML = `
      <div class="variant-thumb active" data-type="main">
        <img src="${product.thumbnail}" alt="Main product">
      </div>
      ${product.product_variants
        .map(
          (variant) => `
        <div class="variant-thumb" data-variant-id="${variant.id}">
          <img src="${variant.thumbnail}" alt="${variant.variant_name}">
        </div>
      `
        )
        .join("")}
    `;

          // Handle thumbnail clicks
          variantThumbs.querySelectorAll(".variant-thumb").forEach((thumb) => {
            thumb.addEventListener("click", () => {
              // Update active state
              variantThumbs
                .querySelectorAll(".variant-thumb")
                .forEach((t) => t.classList.remove("active"));
              thumb.classList.add("active");

              // Update main slider
              const isMain = thumb.dataset.type === "main";
              const imgSrc = isMain
                ? product.thumbnail
                : product.product_variants.find(
                    (v) => v.id === parseInt(thumb.dataset.variantId)
                  ).thumbnail;

              swiperWrapper.innerHTML = `
          <div class="swiper-slide product-slide">
            <img src="${imgSrc}" alt="${product.name}">
          </div>
        `;
              productSwiper.update();
            });
          });

          // Update variant selection to also update thumbnail
          ["modal", "buyNow"].forEach((prefix) => {
            const variantOptions = document.getElementById(
              `${prefix}VariantOptions`
            );
            variantOptions.innerHTML = product.product_variants
              .map(
                (variant) => `
        <button class="variant-option" 
                data-variant-id="${variant.id}" 
                data-stock="${variant.stock}"
                data-thumbnail="${variant.thumbnail}">
          ${variant.variant_name}
        </button>
      `
              )
              .join("");

            variantOptions
              .querySelectorAll(".variant-option")
              .forEach((button) => {
                button.addEventListener("click", () => {
                  // Update variant selection
                  variantOptions
                    .querySelectorAll(".variant-option")
                    .forEach((btn) => btn.classList.remove("selected"));
                  button.classList.add("selected");

                  // Update stock display
                  document.getElementById(`${prefix}ProductStock`).textContent =
                    button.dataset.stock;

                  // Update thumbnail in modal
                  document.getElementById(`${prefix}ProductImage`).src =
                    button.dataset.thumbnail;

                  // Update main slider and thumbnail strip
                  const variantId = parseInt(button.dataset.variantId);
                  const variantThumb = document.querySelector(
                    `.variant-thumb[data-variant-id="${variantId}"]`
                  );
                  if (variantThumb) variantThumb.click();
                });
              });
          });

          // Update product info
          document.querySelector(".product-name").textContent = product.name;
          document.querySelector(
            ".product-price"
          ).textContent = `Rp ${product.price.toLocaleString()}`;
          document.querySelector(
            ".coin-plus"
          ).textContent = `+${product.coin_plus} coins`;
          document.querySelector(".rating-value").textContent = product.rating;
          document.querySelector(".sales-count").textContent = "Sold 1.2k";
          document.querySelector(".description-content").textContent =
            product.description;

          cartManager.updateCartBadge();
        } catch (error) {
          console.error("Error loading product details:", error);
        }
      }

      // Add to cart handler
      document.querySelector(".add-cart-btn").addEventListener("click", () => {
        const modal = new bootstrap.Modal(
          document.getElementById("addToCartModal")
        );
        modal.show();
      });

      // Modal quantity handlers
      const modalQuantityInput = document.getElementById("modalQuantity");
      document
        .getElementById("modalDecreaseQty")
        .addEventListener("click", () => {
          if (modalQuantityInput.value > 1) {
            modalQuantityInput.value = parseInt(modalQuantityInput.value) - 1;
          }
        });

      document
        .getElementById("modalIncreaseQty")
        .addEventListener("click", () => {
          modalQuantityInput.value = parseInt(modalQuantityInput.value) + 1;
        });

      // Modal add to cart handler
      document
        .getElementById("modalAddToCart")
        .addEventListener("click", () => {
          const selectedVariant = document.querySelector(
            ".variant-option.selected"
          );
          if (!selectedVariant) {
            alert("Please select a variant");
            return;
          }

          const variantId = selectedVariant.dataset.variantId;
          const stock = parseInt(selectedVariant.dataset.stock);
          const quantity = parseInt(
            document.getElementById("modalQuantity").value
          );

          if (stock <= 0) {
            alert("Product is out of stock");
            return;
          }

          if (quantity <= 0 || quantity > stock) {
            alert("Please select a valid quantity");
            return;
          }

          cartManager.addToCart({
            id: productId,
            variantId: variantId,
            quantity: quantity,
            timestamp: new Date().toISOString(),
          });

          bootstrap.Modal.getInstance(
            document.getElementById("addToCartModal")
          ).hide();
          alert("Product added to cart!");
        });

      // Buy now handler
      document.querySelector(".buy-now-btn").addEventListener("click", () => {
        const modal = new bootstrap.Modal(
          document.getElementById("buyNowModal")
        );
        modal.show();
      });

      const buyNowQuantityInput = document.getElementById("buyNowQuantity");

      document
        .getElementById("buyNowDecreaseQty")
        .addEventListener("click", () => {
          if (buyNowQuantityInput.value > 1) {
            buyNowQuantityInput.value = parseInt(buyNowQuantityInput.value) - 1;
          }
        });

      document
        .getElementById("buyNowIncreaseQty")
        .addEventListener("click", () => {
          buyNowQuantityInput.value = parseInt(buyNowQuantityInput.value) + 1;
        });

      // Add buy now confirm handler
      document.getElementById("buyNowConfirm").addEventListener("click", () => {
        const selectedVariant = document.querySelector(
          "#buyNowVariantOptions .variant-option.selected"
        );
        if (!selectedVariant) {
          alert("Please select a variant");
          return;
        }

        const variantId = parseInt(selectedVariant.dataset.variantId);
        const stock = parseInt(selectedVariant.dataset.stock);
        const quantity = parseInt(
          document.getElementById("buyNowQuantity").value
        );

        if (stock <= 0) {
          alert("Product is out of stock");
          return;
        }

        if (quantity <= 0 || quantity > stock) {
          alert("Please select a valid quantity");
          return;
        }

        const variant = window.productData.product_variants.find(
          (v) => v.id === variantId
        );

        if (!variant) {
          alert("Error finding variant details");
          return;
        }

        // Create checkout item
        const checkoutItem = [
          {
            id: parseInt(productId),
            variantId: variantId,
            quantity: quantity,
            timestamp: new Date().toISOString(),
            productName: window.productData.name,
            thumbnail: window.productData.thumbnail,
            variantName: selectedVariant.textContent.trim(),
            price: variant.price,
          },
        ];

        // Store in localStorage for checkout
        localStorage.setItem("checkoutItems", JSON.stringify(checkoutItem));

        // Redirect to checkout
        window.location.href = "checkout.html";
      });
    </script>
  </body>
</html>
