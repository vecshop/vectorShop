<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Builder - Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <style>
      .form-builder {
        min-height: 400px;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 1rem;
      }

      .field-types .card {
        cursor: pointer;
        transition: all 0.2s;
      }

      .field-types .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .field-preview {
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-top: 1rem;
      }

      .field-types .card i {
        color: #0d6efd;
        margin-bottom: 0.5rem;
        display: block;
      }

      .field-types .card:hover i {
        transform: scale(1.1);
        transition: transform 0.2s;
      }
    </style>
  </head>
  <body>
    <main class="container py-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>Form Builder</h4>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#newFormModal"
        >
          <i class="bi bi-plus-lg"></i> New Form
        </button>
      </div>

      <!-- Template Info Alert -->
      <div
        id="templateInfo"
        class="alert alert-info mb-4"
        style="display: none"
      >
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">
              Current Template: <span id="templateName"></span>
            </h6>
            <small
              >Add fields to your form template and click save when done.</small
            >
          </div>
          <button id="saveFieldsBtn" class="btn btn-success">
            <i class="bi bi-save"></i> Save Fields to Database
          </button>
        </div>
      </div>

      <!-- Form Builder Area -->
      <div class="row">
        <!-- Form Builder -->
        <div class="col-md-8">
          <div class="form-builder"></div>
        </div>

        <!-- Field Types -->
        <div class="col-md-4">
          <div class="field-types">
            <h5 class="mb-3">Available Fields</h5>
            <div class="row g-3">
              <!-- Short Text -->
              <div class="col-6">
                <div class="card h-100" data-field-type="shortText">
                  <div class="card-body text-center">
                    <i class="bi bi-input-cursor-text fs-3 mb-2"></i>
                    <h6>Short Text</h6>
                  </div>
                </div>
              </div>
              <!-- Long Text -->
              <div class="col-6">
                <div class="card h-100" data-field-type="longText">
                  <div class="card-body text-center">
                    <i class="bi bi-textarea-resize fs-3 mb-2"></i>
                    <h6>Long Text</h6>
                  </div>
                </div>
              </div>
              <!-- Image Upload -->
              <div class="col-6">
                <div class="card h-100" data-field-type="imageUploader">
                  <div class="card-body text-center">
                    <i class="bi bi-image fs-3 mb-2"></i>
                    <h6>Image Upload</h6>
                  </div>
                </div>
              </div>
              <!-- File Upload -->
              <div class="col-6">
                <div class="card h-100" data-field-type="fileUploader">
                  <div class="card-body text-center">
                    <i class="bi bi-file-earmark-arrow-up fs-3 mb-2"></i>
                    <h6>File Upload</h6>
                  </div>
                </div>
              </div>
              <!-- Switcher -->
              <div class="col-6">
                <div class="card h-100" data-field-type="switcher">
                  <div class="card-body text-center">
                    <i class="bi bi-toggle2-on fs-3 mb-2"></i>
                    <h6>Switcher</h6>
                  </div>
                </div>
              </div>
              <!-- Slider -->
              <div class="col-6">
                <div class="card h-100" data-field-type="slider">
                  <div class="card-body text-center">
                    <i class="bi bi-sliders fs-3 mb-2"></i>
                    <h6>Slider</h6>
                  </div>
                </div>
              </div>
              <!-- Card Choice -->
              <div class="col-6">
                <div class="card h-100" data-field-type="cardChoice">
                  <div class="card-body text-center">
                    <i class="bi bi-grid-3x3-gap fs-3 mb-2"></i>
                    <h6>Card Choice</h6>
                  </div>
                </div>
              </div>
              <!-- Multiple Choice -->
              <div class="col-6">
                <div class="card h-100" data-field-type="multipleChoice">
                  <div class="card-body text-center">
                    <i class="bi bi-list-check fs-3 mb-2"></i>
                    <h6>Multiple Choice</h6>
                  </div>
                </div>
              </div>
              <!-- File Preview -->
              <div class="col-6">
                <div class="card h-100" data-field-type="filePreview">
                  <div class="card-body text-center">
                    <i class="bi bi-file-earmark-text fs-3 mb-2"></i>
                    <h6>File Preview</h6>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- New Form Modal -->
    <div class="modal fade" id="newFormModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create New Form</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="newFormForm">
              <div class="mb-3">
                <label class="form-label">Form Name</label>
                <input type="text" class="form-control" name="name" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Service</label>
                <select class="form-select" name="service_id" required>
                  <option value="">Select Service</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea
                  class="form-control"
                  name="description"
                  rows="3"
                ></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Create Form</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Field Settings Modal -->
    <div class="modal fade" id="fieldSettingsModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Field Settings</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Will be populated dynamically based on field type -->
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      import { supabase } from "../assets/js/supabase.js";
      import { FormBuilder } from "../assets/js/formBuilder.js";

      let formBuilder = null;

      // Initialize when document loads
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          formBuilder = new FormBuilder(
            document.querySelector(".form-builder"),
            supabase
          );

          // Load services for dropdown
          await loadServices();
        } catch (error) {
          console.error("Error initializing:", error);
        }
      });

      async function loadServices() {
        try {
          const { data: services, error } = await supabase
            .from("services")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;

          // Update select in new form modal
          const select = document.querySelector(
            '#newFormForm select[name="service_id"]'
          );
          select.innerHTML = '<option value="">Select Service</option>';
          services.forEach((service) => {
            select.innerHTML += `<option value="${service.id}">${service.name}</option>`;
          });
        } catch (error) {
          console.error("Error loading services:", error);
        }
      }

      // Handle new form creation
      document
        .getElementById("newFormForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const formValues = {
            name: formData.get("name"),
            service_id: parseInt(formData.get("service_id")),
            description: formData.get("description") || "",
            is_active: true,
          };

          try {
            if (!formValues.name || !formValues.service_id) {
              throw new Error("Name and Service are required");
            }

            const { data: template, error: templateError } = await supabase
              .from("service_form_templates")
              .insert([formValues])
              .select()
              .single();

            if (templateError) throw templateError;

            // Set template ID and show template info
            formBuilder.setTemplateId(template.id);
            document.getElementById("templateInfo").style.display = "block";
            document.getElementById("templateName").textContent = template.name;

            // Initialize empty form builder
            formBuilder.loadForm([]);
            bootstrap.Modal.getInstance(
              document.getElementById("newFormModal")
            ).hide();

            // Update UI
            document.querySelector(".form-builder").innerHTML = `
          <div class="text-center p-4">
            <h5>Drag and drop fields here</h5>
            <p class="text-muted">Changes will be saved automatically</p>
          </div>
        `;
          } catch (error) {
            console.error("Error creating form:", error);
            alert(
              error.message ||
                "Error creating form. Please check all required fields."
            );
          }
        });

      // Handle saving form fields
      document
        .getElementById("saveFieldsBtn")
        .addEventListener("click", async () => {
          try {
            if (!formBuilder.templateId) {
              throw new Error("No template selected");
            }

            if (!formBuilder.fields.length) {
              throw new Error("Please add at least one field");
            }

            // Show loading state
            const btn = document.getElementById("saveFieldsBtn");
            const originalText = btn.innerHTML;
            btn.innerHTML =
              '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            btn.disabled = true;

            // Save fields to database
            await formBuilder.saveForm(formBuilder.templateId);

            // Show success message
            btn.innerHTML = '<i class="bi bi-check-lg"></i> Saved Successfully';
            btn.classList.remove("btn-success");
            btn.classList.add("btn-outline-success");

            // Reset button after 2 seconds
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.classList.remove("btn-outline-success");
              btn.classList.add("btn-success");
              btn.disabled = false;
            }, 2000);
          } catch (error) {
            console.error("Error saving fields:", error);
            alert(error.message || "Error saving fields to database");
          }
        });
    </script>
  </body>
</html>
